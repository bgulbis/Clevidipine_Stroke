---
title: "Nicardipine vs. Clevidipine"
output: 
    html_notebook:
        code_folding: hide
        toc: yes
        toc_float: yes
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(results='asis')

library(readxl)
library(tidyverse)
library(stringr)
library(MESS)
library(tableone)

sbp <- read_excel("../data/raw/sbp.xlsx") %>%
    mutate(group = if_else(Group == "N", "Nicardipine", "Clevidipine"),
           goal = if_else(Diagnosis == 1, 180, 150),
           diagnosis = if_else(Diagnosis == 1, "Acute Ischemic Stroke", "Intracerebral Hemorrhage")) %>%
    select(patient = `Patient number`,
           group,
           diagnosis,
           admit = `Admit Time`,
           med.time = Time,
           sbp = SBP,
           goal) %>%
    arrange(patient, med.time) %>%
    group_by(patient) %>%
    mutate(duration = as.numeric(difftime(med.time, first(med.time), units = "hours")),
           interval = as.numeric(difftime(lead(med.time), med.time, units = "hours")),
           interval = coalesce(interval, 0),
           at.goal = sbp <= goal)

sbp.auc <- sbp %>%
    filter(duration <= 24) %>%
    group_by(patient) %>%
    summarize(cum.duration = last(duration),
              sbp.first = first(sbp),
              sbp.last = last(sbp),
              perc.change.sbp = (sbp.last - sbp.first) / sbp.first,
              sbp.min = min(sbp),
              auc.24h = auc(duration, sbp),
              sbp.mean.weighted = auc.24h / cum.duration)

sbp.min <- sbp %>%
    inner_join(sbp.auc, by = "patient") %>%
    filter(sbp == sbp.min) %>%
    arrange(patient, duration) %>%
    group_by(patient) %>%
    summarize(sbp.min.time = first(duration))
    
sbp.change <- sbp %>%
    mutate(diff2 = abs(2 - duration),
           diff6 = abs(6 - duration)) %>%
    group_by(patient) %>%
    filter(duration == 0 | (diff2 == min(diff2) & diff2 <= 1) | (diff6 == min(diff6) & diff6 <= 1)) %>%
    mutate(change = sbp - first(sbp)) %>%
    filter(duration > 0) %>%
    mutate(period = if_else(diff2 <= 1, "change.2hr", if_else(diff6 <= 1, "change.6hr", NA_character_))) %>%
    group_by(patient, period) %>%
    summarize(change = first(change)) %>%
    spread(period, change)

sbp.goal <- sbp %>%
    filter(duration <= 24,
           at.goal == TRUE) %>%
    group_by(patient) %>%
    summarize(time.at.goal = sum(interval))

data.bp <- sbp %>%
    ungroup() %>%
    distinct(patient, group, diagnosis) %>%
    left_join(sbp.auc, by = "patient") %>%
    left_join(sbp.min, by = "patient") %>%
    left_join(sbp.goal, by = "patient") %>%
    mutate(perc.time.at.goal = time.at.goal / cum.duration) %>%
    left_join(sbp.change, by = "patient")

mean.bp <- data.bp %>%
    group_by(group, diagnosis) %>%
    summarize(auc.24h.mean = mean(auc.24h, na.rm = TRUE),
              auc.24h.sd = sd(auc.24h, na.rm = TRUE),
              auc.24h.se = auc.24h.sd / sqrt(length(auc.24h)),
              change.2hr.mean = mean(change.2hr, na.rm = TRUE),
              change.2hr.sd = sd(change.2hr, na.rm = TRUE),
              change.2hr.se = change.2hr.sd / sqrt(length(change.2hr)),
              change.6hr.mean = mean(change.6hr, na.rm = TRUE),
              change.6hr.sd = sd(change.6hr, na.rm = TRUE),
              change.6hr.se = change.6hr.sd / sqrt(length(change.6hr)))

# wilcox.test(auc.24h ~ group, data = data.bp, subset = data.bp$diagnosis == "stroke")

# tests <- data.bp %>%
#     slice_rows("diagnosis") %>%
#     by_slice(partial(wilcox.test, auc.24h ~ group))
# tests$.out
```

### All Patients

**Note:** Data within the first 24 hours only.

```{r sbp_all, results='asis'}
df <- data.bp %>%
    select(patient, group, diagnosis,
           `Starting SBP` = sbp.first,
           `Mean SBP (time-weighted)` = sbp.mean.weighted,
           `Final SBP` = sbp.last,
           `Percent Change in SBP` = perc.change.sbp,
           `Percent Time Below SBP Goal` = perc.time.at.goal,
           `Minimum SBP` = sbp.min,
           `Time to Minimum SBP (hours)` = sbp.min.time,
           `24-Hour SBP AUC` = auc.24h,
           `SBP Change at 2-Hours` = change.2hr,
           `SBP Change at 6-Hours` = change.6hr)

vars <- names(df)[-c(1:3)]
tbl <- CreateTableOne(vars, "group", df)
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl[, 1:3], caption = "All Patients")
```

```{r sbp_median, results='asis'}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = vars)
knitr::kable(ptbl[, 1:3], caption = "Stroke")
```


### Stroke
```{r stroke_mean, results='asis'}
# vars <- c("auc.24h", "change.2hr", "change.6hr")
tbl <- CreateTableOne(vars, "group", df[df$diagnosis == "Acute Ischemic Stroke", ])
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl[, 1:3], caption = "Stroke")
```

```{r stroke_median, results='asis'}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = vars)
knitr::kable(ptbl[, 1:3], caption = "Stroke")
```


### ICH
```{r ich_mean, results='asis'}
tbl <- CreateTableOne(vars, "group", df[df$diagnosis == "Intracerebral Hemorrhage", ])
ptbl <- print(tbl, printToggle = FALSE)
knitr::kable(ptbl[, 1:3], caption = "ICH")
```

```{r ich_median, results='asis'}
ptbl <- print(tbl, printToggle = FALSE, nonnormal = vars)
knitr::kable(ptbl[, 1:3], caption = "ICH")
```

### Figures

```{r}
sbp %>%
    filter(duration < 25) %>%
    ggplot(aes(x = duration, y = sbp)) +
    geom_point(aes(color = group), alpha = 0.7, size = 0.7) +
    geom_smooth(aes(linetype = group), color = "black") +
    ggtitle("Figure 1. Change in systolic blood pressure") +
    xlab("Time from admission (hours)") +
    ylab("Systolic blood pressure (mmHg)") +
    facet_grid(. ~ diagnosis) +
    scale_x_continuous(breaks = seq(0, 24, 6)) +
    scale_linetype(name = "Trend") +
    # scale_shape(name = "Values", solid = FALSE) +
    scale_color_brewer(palette = "Paired", guide = guide_legend(title = "Values")) +
    theme_bw() +
    coord_cartesian(ylim = c(50, 250))
```
